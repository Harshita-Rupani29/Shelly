name: Copilot Review

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write

jobs:
  copilot-review:
    runs-on: ubuntu-latest
    name: ðŸ¤– AI Code Review
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run linting
        run: npm run lint
        continue-on-error: true

      - name: Run type checking
        if: hashFiles('tsconfig.json') != ''
        run: npx tsc --noEmit
        continue-on-error: true

      - name: Generate PR Summary
        uses: actions/github-script@v7
        with:
          script: |
            const { data: files } = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });

            const stats = {
              added: files.filter(f => f.status === 'added').length,
              modified: files.filter(f => f.status === 'modified').length,
              removed: files.filter(f => f.status === 'removed').length,
              total: files.length,
              additions: files.reduce((acc, f) => acc + f.additions, 0),
              deletions: files.reduce((acc, f) => acc + f.deletions, 0)
            };

            const fileTypes = files.reduce((acc, f) => {
              const parts = f.filename.split('.');
              const ext = parts.length > 1 ? parts.pop() : 'other';
              acc[ext] = (acc[ext] || 0) + 1;
              return acc;
            }, {});

            const topTypes = Object.entries(fileTypes)
              .sort((a, b) => b[1] - a[1])
              .slice(0, 5)
              .map(([ext, count]) => `\`.${ext}\` (${count})`)
              .join(', ');

            const body = `## ðŸ¤– PR Analysis Summary

### ðŸ“Š Change Statistics
| Metric | Count |
|--------|-------|
| Files Changed | ${stats.total} |
| Files Added | ${stats.added} |
| Files Modified | ${stats.modified} |
| Files Removed | ${stats.removed} |
| Lines Added | +${stats.additions} |
| Lines Removed | -${stats.deletions} |

### ðŸ“ File Types Changed
${topTypes || 'No files changed'}

---
*ðŸ¤– Automated analysis by {{repoName}}*`;

            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });

            const existingComment = comments.find(c =>
              c.user?.login === 'github-actions[bot]' &&
              c.body.includes('PR Analysis Summary')
            );

            if (existingComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existingComment.id,
                body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body
              });
            }
